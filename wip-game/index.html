<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Analyst Simulator Prototype - Improved</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; display: flex; height: 100vh;
    background: #222; color: #eee;
  }
  #leftPanel, #rightPanel {
    padding: 10px;
    box-sizing: border-box;
  }
  #leftPanel {
    width: 45%; border-right: 2px solid #444;
    display: flex; flex-direction: column;
  }
  #rightPanel {
    width: 55%;
    display: flex; flex-direction: column;
  }
  h2 { margin-top: 0; }
  #docTitle { font-weight: bold; font-size: 1.2em; margin-bottom: 6px; }
  #docText { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; white-space: pre-wrap; }
  #docImage {
    max-width: 100%;
    max-height: 200px;
    margin-bottom: 10px;
    border: 1px solid #555;
    object-fit: contain;
    width: auto;
    height: auto;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  #wikiTitle { width: 100%; padding: 6px; font-size: 1em; margin-bottom: 6px; background: #333; border: none; color: #eee; }
  #wikiBody {
    flex-grow: 1;
    width: 100%;
    padding: 6px;
    background: #333;
    border: none;
    color: #eee;
    resize: vertical;
    min-height: 150px;
  }
  #controls {
    margin-top: 8px;
    display: flex; justify-content: space-between; align-items: center;
  }
  button {
    padding: 8px 14px;
    font-size: 1em;
    border: none;
    background: #0a84ff;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }
  button:disabled {
    background: #555;
    cursor: default;
  }
  #timerBarContainer {
    width: 100%;
    height: 12px;
    background: #444;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 10px;
  }
  #timerBar {
    height: 100%;
    background: #0a84ff;
    width: 100%;
    transition: width 1s linear;
  }
  #reportModal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    color: #eee;
    display: none;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
    z-index: 10;
  }
  #reportModal h2 { margin-top: 0; }
  .question {
    margin-bottom: 20px;
  }
  .choices label {
    display: block;
    margin: 4px 0;
    cursor: pointer;
  }
  #scoreDisplay {
    font-size: 1.3em;
    margin-top: 20px;
    text-align: center;
  }
  #wikiPagesList {
    margin-top: 12px;
    background: #111;
    padding: 6px;
    height: 120px;
    overflow-y: auto;
    border: 1px solid #444;
  }
  #wikiPagesList h3 {
    margin: 0 0 6px 0;
    font-size: 1em;
    text-align: center;
  }
  #wikiPagesList ul {
    list-style: none;
    padding-left: 6px;
    margin: 0;
    font-size: 0.9em;
  }
  #wikiPagesList li {
    cursor: pointer;
    padding: 3px 6px;
    border-radius: 3px;
  }
  #wikiPagesList li:hover {
    background: #0a84ff;
    color: #000;
  }
  #warningMsg {
    color: #f88;
    margin-top: 6px;
    font-size: 0.9em;
    height: 18px;
  }
</style>
</head>
<body>
  <div id="leftPanel">
    <h2>Incoming Intel</h2>
    <div id="timerBarContainer"><div id="timerBar"></div></div>
    <div id="docTitle"></div>
    <img id="docImage" src="" alt="" style="display:none;" />
    <div id="docText"></div>
  </div>

  <div id="rightPanel">
    <h2>Your Notes</h2>
    <input type="text" id="wikiTitle" placeholder="Page Title (e.g. Dorvale)" autocomplete="off" />
    <textarea id="wikiBody" placeholder="Write your notes here..."></textarea>
    <div id="warningMsg"></div>
    <div id="controls">
      <div id="charCount">0 / 150 chars</div>
      <button id="saveNote" disabled>Save Note</button>
      <button id="nextDoc" disabled>Next Document</button>
    </div>
    <div id="wikiPagesList">
      <h3>Saved Pages</h3>
      <ul id="pagesUl"></ul>
    </div>
  </div>

  <div id="reportModal">
    <h2>Report Questions</h2>
    <form id="reportForm"></form>
    <button id="submitReport">Submit Report</button>
    <div id="scoreDisplay"></div>
  </div>

<script>
(() => {
  const documents = [
    {
      id: "doc1",
      title: "Fall of Dorvale",
      text: "The capital city of Dorvale fell after a brutal 12-day siege. General Kiren Mavo led the Pact of Thorne forces in a decisive victory against the Tiraval defenders.",
      image: "https://upload.wikimedia.org/wikipedia/commons/c/c3/General_view_and_Vesuvius%2C_Pompeii%2C_Italy-LCCN2001700924.jpg",
      tags: ["Dorvale", "War", "1938"]
    },
    {
      id: "doc2",
      title: "Political Alliances Form",
      text: "Following the fall of Dorvale, the Pact of Thorne solidified alliances with Krevnia. Tensions rise as Tiraval seeks new allies.",
      tags: ["Diplomacy", "Alliances", "1938"]
    },
    {
      id: "doc3",
      title: "Economic Impact Report",
      text: "The prolonged conflict has drained resources from the involved nations. Dorvale's infrastructure is severely damaged, and recovery efforts are underway.",
      tags: ["Economy", "Dorvale", "Reconstruction"]
    }
  ];

  const truthFile = {
    "Leader_Dorvale_Offensive": "Gen. Kiren Mavo",
    "War_1938_Alliance": "Pact of Thorne",
    "Battle_Order": ["Siege of Taran", "Fall of Dorvale", "Sack of Greyharbor"],
    "Diplomatic_Status": {
      "Tiraval": {"Dorvale": "enemy", "Krevnia": "ally"}
    }
  };

  const reportQuestions = [
    {
      id: "q1",
      type: "multiple_choice",
      prompt: "Who led the Dorvale Offensive?",
      choices: ["Gen. Kiren Mavo", "Admiral Terek", "Col. Vance"],
      answerKey: "Leader_Dorvale_Offensive"
    },
    {
      id: "q2",
      type: "multiple_choice",
      prompt: "Which alliance declared war on Tiraval in 1938?",
      choices: ["Pact of Thorne", "League of Meridia", "Coalition of North"],
      answerKey: "War_1938_Alliance"
    }
  ];

  let currentDocIndex = 0;
  let timerSeconds = 30; // half a minute per document
  let timerInterval = null;

  const docTitleEl = document.getElementById("docTitle");
  const docTextEl = document.getElementById("docText");
  const docImageEl = document.getElementById("docImage");
  const wikiTitleEl = document.getElementById("wikiTitle");
  const wikiBodyEl = document.getElementById("wikiBody");
  const saveNoteBtn = document.getElementById("saveNote");
  const nextDocBtn = document.getElementById("nextDoc");
  const charCountEl = document.getElementById("charCount");
  const timerBarEl = document.getElementById("timerBar");
  const reportModalEl = document.getElementById("reportModal");
  const reportFormEl = document.getElementById("reportForm");
  const submitReportBtn = document.getElementById("submitReport");
  const scoreDisplayEl = document.getElementById("scoreDisplay");
  const pagesUl = document.getElementById("pagesUl");
  const warningMsgEl = document.getElementById("warningMsg");

  // Wiki pages saved in localStorage as {title: body}
  let wikiPages = JSON.parse(localStorage.getItem("wikiPages") || "{}");

  // Load saved current document index from localStorage if any
  const savedIndex = parseInt(localStorage.getItem("currentDocIndex"));
  if (!isNaN(savedIndex) && savedIndex >= 0 && savedIndex < documents.length) {
    currentDocIndex = savedIndex;
  }

  function loadDoc(index) {
    if (index >= documents.length) {
      // Start report phase
      startReport();
      return;
    }
    const doc = documents[index];
    docTitleEl.textContent = doc.title;
    docTextEl.textContent = doc.text;
    if (doc.image) {
      docImageEl.src = doc.image;
      docImageEl.style.display = "block";
    } else {
      docImageEl.style.display = "none";
    }

    wikiTitleEl.value = "";
    wikiBodyEl.value = "";
    warningMsgEl.textContent = "";
    saveNoteBtn.disabled = true;
    nextDocBtn.disabled = true;
    charCountEl.textContent = "0 / 150 chars";

    resetTimer();
    startTimer();
    refreshPagesList();
  }

  function resetTimer() {
    clearInterval(timerInterval);
    timerSeconds = 120;
    updateTimerBar();
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      timerSeconds--;
      updateTimerBar();
      if (timerSeconds <= 0) {
        clearInterval(timerInterval);
        alert("Time's up! Moving to the next document.");
        nextDoc();
      }
    }, 1000);
  }

  function updateTimerBar() {
    const pct = (timerSeconds / 120) * 100;
    timerBarEl.style.width = pct + "%";
  }

  // Simple similarity: Jaccard index on words sets
  function similarityCheck(textA, textB) {
    const setA = new Set(textA.toLowerCase().match(/\b\w+\b/g) || []);
    const setB = new Set(textB.toLowerCase().match(/\b\w+\b/g) || []);
    if (setA.size === 0 || setB.size === 0) return 0;
    let intersection = 0;
    for (let word of setA) if (setB.has(word)) intersection++;
    return intersection / (setA.size + setB.size - intersection);
  }

  function saveNote() {
    const title = wikiTitleEl.value.trim();
    const body = wikiBodyEl.value.trim();
    if (title.length === 0) {
      alert("Please enter a page title.");
      return;
    }
    if (body.length < 150) {
      alert("Please write at least 150 characters.");
      return;
    }
    // Similarity check to current doc text
    const currentDocText = documents[currentDocIndex].text;
    const sim = similarityCheck(body, currentDocText);
    if (sim > 0.6) {
      warningMsgEl.textContent = "Your note is too similar to the source document. Please paraphrase more.";
      return;
    } else {
      warningMsgEl.textContent = "";
    }

    wikiPages[title] = body;
    localStorage.setItem("wikiPages", JSON.stringify(wikiPages));
    alert(`Note "${title}" saved.`);
    saveNoteBtn.disabled = true;
    nextDocBtn.disabled = false;
    refreshPagesList();
  }

  function nextDoc() {
    currentDocIndex++;
    localStorage.setItem("currentDocIndex", currentDocIndex);
    loadDoc(currentDocIndex);
  }

  function onWikiChange() {
    const bodyLength = wikiBodyEl.value.trim().length;
    charCountEl.textContent = `${bodyLength} / 150 chars`;
    const canSave = bodyLength >= 150 && wikiTitleEl.value.trim().length > 0;
    saveNoteBtn.disabled = !canSave;
    if (canSave) warningMsgEl.textContent = "";
  }

  function refreshPagesList() {
    pagesUl.innerHTML = "";
    const titles = Object.keys(wikiPages).sort();
    for (const title of titles) {
      const li = document.createElement("li");
      li.textContent = title;
      li.title = "Click to load this note";
      li.onclick = () => {
        wikiTitleEl.value = title;
        wikiBodyEl.value = wikiPages[title];
        charCountEl.textContent = `${wikiBodyEl.value.length} / 150 chars`;
        saveNoteBtn.disabled = true;
        nextDocBtn.disabled = false;
        warningMsgEl.textContent = "";
      };
      pagesUl.appendChild(li);
    }
  }

  // Report phase
  function startReport() {
    clearInterval(timerInterval);
    document.body.style.overflow = "hidden";
    reportModalEl.style.display = "flex";
    localStorage.removeItem("currentDocIndex"); // clear progress on report phase start
    buildReportForm();
  }

  function buildReportForm() {
    reportFormEl.innerHTML = "";
    reportQuestions.forEach((q, i) => {
      const qDiv = document.createElement("div");
      qDiv.classList.add("question");

      const prompt = document.createElement("div");
      prompt.textContent = (i + 1) + ". " + q.prompt;
      qDiv.appendChild(prompt);

      const choicesDiv = document.createElement("div");
      choicesDiv.classList.add("choices");

      q.choices.forEach(choice => {
        const label = document.createElement("label");
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = q.id;
        radio.value = choice;
        label.appendChild(radio);
        label.appendChild(document.createTextNode(choice));
        choicesDiv.appendChild(label);
      });

      qDiv.appendChild(choicesDiv);
      reportFormEl.appendChild(qDiv);
    });
  }

  function submitReport() {
    const formData = new FormData(reportFormEl);
    let score = 0;
    let maxScore = reportQuestions.length;

    for (const q of reportQuestions) {
      const answer = formData.get(q.id);
      if (answer === truthFile[q.answerKey]) {
        score++;
      }
    }

    scoreDisplayEl.textContent = `Your score: ${score} / ${maxScore}`;
    submitReportBtn.disabled = true;
  }

  wikiBodyEl.addEventListener("input", onWikiChange);
  wikiTitleEl.addEventListener("input", onWikiChange);
  saveNoteBtn.addEventListener("click", saveNote);
  nextDocBtn.addEventListener("click", () => {
    if (nextDocBtn.disabled) return;
    nextDoc();
  });
  submitReportBtn.addEventListener("click", submitReport);

  // Initialize
  refreshPagesList();
  loadDoc(currentDocIndex);
})();
</script>
</body>
</html>
